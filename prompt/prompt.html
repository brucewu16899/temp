<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=GBK" />
<title>提词器</title>
<style type="text/css">
body {
	margin: 0px;
	overflow: hidden;
}
#stage {
	position: relative;
	overflow: hidden;
	height: 50%;
	display: none;
}
#slide {
	white-space: pre;
	font-family: 微软雅黑;
	font-size: 1em;
	line-height: 1.8em;
	background-color: black;
	width: 100%;
	min-height: 20em;
	padding-bottom: 20em;
	text-align: center;
}
#slide div {
	transition: color 1s;
	color: white;
}
#slide div.current-line {
	color: red;
}

#toolbar {
	position: fixed;
	left: 0px;
	bottom: 0px;
	width: 100%;
	padding: 10px;
	background-color: #dfdfe0;
	border-top: 1px solid #aaaaab;
}
#toolbar > span {
	display: inline-block;
	font-size: 12px;
}
#toolbar input {
	vertical-align: sub;
}
.btn {
	border: 1px solid silver;
	padding: 5px;
	cursor: pointer;
}
.btn:hover {
	border: 1px solid black;
}
.btn.pressed {
	background-color: gray;
	color: white;
	cursor: default;
	border: 1px solid silver;
}

.seperate {
	margin-left: 30px;
}
.btn-speed {
	padding-left: 10px;
	padding-right: 10px;
}

#progress {
	width: 10px;
	overflow-x: visible;
}
#progress #sofar {
	display: inline-block;
	background-color: #10ff10;
	height: 1.5em;
	vertical-align: bottom;
	transition: width 1s;
}
#progress #rest {
	display: inline-block;
	background-color: red;
	height: 1.5em;
	vertical-align: bottom;
	transition: width 1s;
}
</style>
</head>
<body>
<textarea id="source">
[ti:看不懂的英美法]
[ar:罗辑思维]

00:17 开篇引入话题
感谢给位来到《罗辑思维》捧场
今天我们共同去面对一个非常艰深 非常专业的话题
叫英美法系 也就是今天主要应用在
英格兰和美国地区的那个法律体系
你可能觉得奇怪 为什么要说这个呢
这根我们当代中国人有一毛钱关系吗
先别着急 《罗辑思维》从来不讲无缘无故的话题
至于为什么要讲 先卖个关子 一会儿向大伙交代
英美法系这个话题 对我们来说太艰深了
虽然罗胖自己当过什么法制节目的制片人
我们本期节目的策划人刘学先生也是本科读的法律专业
但是我们仍然觉得这个题目很难 所以我们读了书
请教了高人 反复开会 最后是策划案六易其稿
才敢端出来跟您分享 顺便夸下我们的内容团队
我们有着旺盛的好奇心 任何事物只要它足够奇葩
从我们的日常生活经验中无法直觉地得出结论的
我们都非常有兴趣上去琢磨一下
从现象到本质把它理解一下
直到我们自己觉得已经言之成理 持之有据了
我们才会端出来和大伙儿聊一聊
这就是我们死磕自己 愉悦大家的精神
你可能会注意到 我刚才的言谈当中用了一个词
叫奇葩 英美法系是人类法律体系当中的奇葩
是个另类 那请问正常的法律体系什么样呢
</textarea>
<div id="stage">
	<div id="slide"></div>
</div>
<div id="toolbar">
	<span id="btn-source" class="btn">文本编辑</span>
	<span id="btn-play" class="btn">播放</span>

	<span class="seperate"><input type="checkbox" id="btn-flip" value="true"/><label for="btn-flip">翻转</label></span>

	<span id="btn-dec-speed" class="btn btn-speed seperate">-</span>
	<span id="btn-reset-speed" class="btn btn-speed">每分钟 <span id="speed">280</span> 字</span>
	<span id="btn-inc-speed" class="btn btn-speed">+</span>

	<span id="progress-anchor" class="seperate"></span>
	<span id ="progress">
		<span id="sofar"></span><span id="rest"></span>
	</span>
</div>

<script src="jquery-1.11.1.js"></script>
<script>
// http://api.jquery.com/
$(function() {
	// 设置初始状态
	resizeStage();
	$('#source').show();
	$('#stage').hide();
	$('#progress').hide();
	$('#btn-source').addClass('pressed');
	$('#btn-flip').get(0).checked = true;

	// 切换状态“文本编辑/播放”
	$('#btn-source').on('click', function() {
		if ($('#btn-source').hasClass('pressed')) return;
		switchMode('source');
	});
	$('#btn-play').on('click', function() {
		if ($('#btn-play').hasClass('pressed')) return;
		switchMode('play');
	});

	// 阻止选择文本，便于快速连点按钮
	$('#toolbar').on('selectstart', function(evt) {
		evt.preventDefault();
	});

	// 控制语速
	$('#btn-dec-speed').on('click', function() {
		adjustSpeed(-10);
	});
	$('#btn-inc-speed').on('click', function() {
		adjustSpeed(10);
	});
	$('#btn-reset-speed').on('click', function() {
		$('#speed').text('280');
	});

	// 控制镜像翻转
	$('#btn-flip').on('change', resetFlip);

	// 鼠标滚轮动作
	$('#stage').on('mousewheel', function(evt) {
		evt.preventDefault();
		slideStop();
		$('#stage').scrollTop($('#stage').scrollTop() - evt.originalEvent.wheelDeltaY);
		$('#slide div').removeClass('current-line');
		slideUp();
	});

	$(document).on('keypress', function(evt) {
		if (evt.charCode == 32) { // 空格键
			if (evt.target.id == 'source') return;
			switchMode('toggle');
		}
	});
});

// mode - source / play / toggle
function switchMode(mode)
{
	if (mode == 'toggle') {
		mode = $('#btn-source').hasClass('pressed') ? 'play' : 'source';
	}
	if (mode == 'source') {
		slideStop();
		$('#btn-source').addClass('pressed');
		$('#btn-play').removeClass('pressed');
		$('#source').show();
		$('#stage').hide();
		$('#progress').hide();
	} else {
		slideStop();
		$('#btn-play').addClass('pressed');
		$('#btn-source').removeClass('pressed');
		parseSource();
		resetFlip();
		$('#source').hide();
		$('#stage').show();
		$('#progress').show();

		$('#stage').scrollTop(0);
		slideUp();
	}
}

// 调整语速：字/分钟
function adjustSpeed(inc)
{
	var speed = parseInt($('#speed').text()) + inc;
	if (speed < 100) speed = 100;
	if (speed > 500) speed = 500;
	$('#speed').text(speed);
}

var totalCharNum = 0;
var maxLineCharNum = 0;
function appendLine(line)
{
	totalCharNum += Math.max(line.replace(/[，、。！“”‘’：《》 ,\.!"':<>]/g, '').length, 3);
	maxLineCharNum = Math.max(maxLineCharNum, line.length);
	if (line.length > 0) {
		$('<div/>').text(line).appendTo('#slide').data('data-sofar', totalCharNum);
	} else {
		$('<div>&nbsp;</div>').appendTo('#slide').data('data-sofar', totalCharNum);
	}
}
function parseSource()
{
	totalCharNum = 0;
	maxLineCharNum = 0;
	$('#slide').empty();
	appendLine('');
	appendLine('');
	appendLine('');
	appendLine('');
	appendLine('');
	appendLine('');
	$.each($('#source').val().split('\n'), function(idx, line) {
		appendLine(line.trim());
	});
	resetFontSize();
}

function resetFontSize()
{
	if (maxLineCharNum == 0) return;
	var szY = Math.floor(($(window).height() - $('#toolbar').outerHeight()) / 15); // 最多容纳 15 行
	var szX = Math.floor($(window).width() / maxLineCharNum); // 确保能完整显示最长的行
	var sz = szX < szY ? szX : szY;
	$('#stage').css('font-size', sz + 'px');
	//console.log('字体[' + sz + ']  行高[' + (sz*1.8) + ']');
}

function slideUp()
{
	slideStop();

	// 找到当前行（位于中心位置偏下一行）
	var w = $('#stage').width();
	var h = $('#stage').height();
	var cur = $(document.elementFromPoint(w/2, h/2)).next();
	if (cur.length == 0) return;

	window._curLine = cur;
	window._curLine.addClass('current-line');

	// 计算滚动目标位置
	var scrollTop = $('#stage').scrollTop() + window._curLine.outerHeight();

	// 计算滚动所需时间
	var speed = parseInt($('#speed').text());
	var chars = Math.max(window._curLine.text().trim().length, 3);
	var duration = chars / speed * 60 * 1000;

	// 滚动文字
	window._curSlide = $('#stage').animate({
		scrollTop: scrollTop
	}, {
		duration: duration,
		easing: 'linear',
		complete: slideUp
	});

	// 计算播放进度
	var total = $('#toolbar').innerWidth() - $('#progress-anchor').position()['left'] - 100;
	var sofar = Math.floor(total * window._curLine.data('data-sofar') / totalCharNum);
	var rest = total - sofar;
	$('#progress').width(total);
	$('#sofar').width(sofar);
	$('#rest').width(rest);
}

function slideStop()
{
	if (window._curSlide) {
		window._curSlide.stop();
		window._curSlide = null;
	}
	if (window._curLine) {
		window._curLine.removeClass('current-line');
		window._curLine = null;
	}
}

function resetFlip()
{
	if ($('#btn-flip').get(0).checked) {
		$('#slide').css('transform', 'scaleX(-1)');
		$('#progress').css('transform', 'scaleX(-1)');
	} else {
		$('#slide').css('transform', 'none');
		$('#progress').css('transform', 'none');
	}
	// checkbox 去焦，避免影响空格键操作
	$('#btn-flip').blur();
}

function resizeStage()
{
	var w = $(window).width();
	var h = $(window).height() - $('#toolbar').outerHeight();
	$('#stage').width(w).height(h);
	$('#source').width(w).height(h);
	resetFontSize();
}
$(window).on('resize', resizeStage);
</script>
</body>
</html>